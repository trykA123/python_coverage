# GitHub Actions configuration **EXAMPLE**,
# MODIFY IT ACCORDING TO YOUR NEEDS!
# Reference: https://docs.github.com/en/actions

name: tests

on:
  push:
    branches: "**"
  pull_request:
    branches: "**"

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with: { fetch-depth: 0 } # deep clone for setuptools-scm
      - uses: actions/setup-python@v4
        id: setup-python
        with: { python-version: "3.11" }
      - name: Build package distribution files
        run: >-
          pipx run --python '${{ steps.setup-python.outputs.python-path }}'
          tox -e clean,build

      # - name: Code Coverage Report
      #   uses: irongut/CodeCoverageSummary@v1.3.0

      #   with:
      #     filename: coverage.xml
      #     badge: true
      #     fail_below_min: true
      #     format: markdown
      #     hide_branch_rate: false
      #     hide_complexity: true
      #     indicators: true
      #     output: both
      #     thresholds: "40 80"

      # - name: Add Coverage PR Comment
      #   uses: marocchino/sticky-pull-request-comment@v2
      #   if: always()
      #   with:
      #     recreate: true
      #     path: code-coverage-results.md

      - uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage.xml

  upload_coverage_to_influxdb:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Download coverage report
        uses: actions/download-artifact@v3
        with:
          name: coverage-report

      - name: Extract coverage percentage
        id: get_coverage
        run: |
          LINE_RATE=$(grep -oP 'line-rate="\K[^"]*' coverage.xml | head -1)
          COVERAGE=$(echo "$LINE_RATE" | awk '{printf "%.2f", $1 * 100}')
          echo "Coverage: $COVERAGE%"
          echo "::set-output name=coverage::$COVERAGE"

      - name: Upload coverage to InfluxDB
        run: |
          curl -X POST "${{ secrets.INFLUXDB_URL }}/api/v2/write?org=${{ secrets.INFLUXDB_ORG }}&bucket=${{ secrets.INFLUXDB_BUCKET }}&precision=s" \
          -H "Authorization: Token ${{ secrets.INFLUXDB_TOKEN }}" \
          --data-raw "rust_code_coverage,repository=${GITHUB_REPOSITORY},branch=${{ github.ref_name }} coverage=${{ steps.get_coverage.outputs.coverage }}"
